<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PascalGames - Modo PC & AR</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body, html {
            margin: 0; padding: 0; overflow: hidden;
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            background-color: #000;
            user-select: none;
        }

        /* Contenedor principal para video y canvas */
        .camera-container {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        /* Video original (oculto, MediaPipe lo procesa) */
        .input_video { display: none; }

        /* Canvas donde dibujamos el video + tracking */
        .output_canvas {
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Modo espejo */
        }

        #game-layer {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 5; pointer-events: none;
        }

        /* El cursor del dedo (punto rojo) */
        #finger-cursor {
            position: absolute;
            width: 20px; height: 20px;
            background: rgba(255, 0, 0, 0.7);
            border: 2px solid white;
            border-radius: 50%;
            z-index: 10;
            pointer-events: none;
            display: none; /* Se activa si detecta mano */
            box-shadow: 0 0 10px red;
            transition: left 0.1s, top 0.1s;
        }

        #hud {
            position: absolute; top: 20px; width: 100%;
            text-align: center; pointer-events: auto; z-index: 15;
            background: rgba(0,0,0,0.3); padding: 10px 0;
        }

        .target-box {
            display: inline-block; width: 50px; height: 50px; margin: 5px;
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #333; border-radius: 10px;
            font-size: 30px; line-height: 50px; font-weight: bold; color: #333;
        }
        .filled { background: #4CAF50; color: white; animation: popIn 0.3s ease-out; }

        .bubble {
            position: absolute; width: 80px; height: 80px;
            background: radial-gradient(circle at 30% 30%, #ffeb3b, #fbc02d);
            border: 3px solid #fff; border-radius: 50%;
            text-align: center; line-height: 75px;
            font-size: 40px; font-weight: bold; color: #d84315;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            cursor: pointer; pointer-events: auto;
            animation: float 4s infinite ease-in-out alternate;
        }
        .bubble:hover { transform: scale(1.1); border-color: #ff5252; }
        
        #start-screen, #win-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 20;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: white; text-align: center;
        }
        button {
            padding: 15px 40px; font-size: 24px;
            background: #2196F3; color: white; border: none; border-radius: 50px;
            cursor: pointer; margin-top: 20px;
        }
        
        .hidden { display: none !important; }
        @keyframes popIn { 0% {transform: scale(0);} 80% {transform: scale(1.2);} 100% {transform: scale(1);} }
        @keyframes float { 0% {transform: translateY(0);} 100% {transform: translateY(-20px);} }
        
        /* Indicador de carga */
        #loading-msg { font-size: 14px; color: #aaa; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="camera-container">
        <video class="input_video"></video>
        <canvas class="output_canvas"></canvas>
    </div>

    <div id="finger-cursor"></div>

    <div id="game-layer">
        <div id="bubbles-container"></div>
    </div>

    <div id="hud">
        <div id="slots-container"></div>
    </div>

    <div id="start-screen">
        <h1>üñêÔ∏è PascalGames PC & AR</h1>
        <p>Usa el MOUSE o levanta tu DEDO √çNDICE frente a la c√°mara.</p>
        <button onclick="initGame()">ACTIVAR C√ÅMARA</button>
        <p id="loading-msg">Cargando inteligencia artificial...</p>
    </div>

    <div id="win-screen" class="hidden">
        <h1 style="font-size: 60px;">üéâ</h1>
        <h2 id="win-word">PALABRA</h2>
        <button onclick="nextLevel()">Siguiente ‚û°Ô∏è</button>
    </div>

    <script>
        // === BANCO DE PALABRAS ===
        const words = ["PATO", "SAPO", "LUNA", "SOL", "MAMA", "PAPA", "OSO", "AUTO", "CASA", "PERRO", "GATO", "MESA", "SILLA", "AGUA", "FLOR", "RIO", "MAR", "TREN", "AVION", "UVA"];
        
        // === VARIABLES DEL JUEGO ===
        let targetWord = "";
        let currentIdx = 0;
        const synth = window.speechSynthesis;
        let isGameRunning = false;
        let lastTouchedTime = 0; // Para evitar doble toque r√°pido

        // Elementos DOM
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const canvasCtx = canvasElement.getContext('2d');
        const fingerCursor = document.getElementById('finger-cursor');
        const bubblesContainer = document.getElementById('bubbles-container');
        const slotsContainer = document.getElementById('slots-container');

        // === CONFIGURACI√ìN MEDIAPIPE (IA DE MANOS) ===
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7, // Qu√© tan seguro debe estar para detectar mano
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        // Esta funci√≥n corre en cada frame de video
        function onResults(results) {
            // 1. Dibujar el video en el canvas
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            // 2. Si detecta manos
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                
                // Obtener punta del dedo √≠ndice (Landmark #8)
                const indexFingerTip = landmarks[8];
                
                // Convertir coordenadas normalizadas (0-1) a pixeles de pantalla
                // NOTA: Como el canvas est√° en espejo (scaleX -1), invertimos la X
                const x = (1 - indexFingerTip.x) * window.innerWidth;
                const y = indexFingerTip.y * window.innerHeight;

                // Mover el cursor rojo visual
                fingerCursor.style.display = 'block';
                fingerCursor.style.left = (x - 10) + 'px'; // -10 para centrar
                fingerCursor.style.top = (y - 10) + 'px';

                // Detectar colisi√≥n con letras
                checkCollision(x, y);
            } else {
                fingerCursor.style.display = 'none';
            }
            canvasCtx.restore();
        }

        function checkCollision(x, y) {
            const now = Date.now();
            if (now - lastTouchedTime < 500) return; // Cooldown de 0.5s

            const bubbles = document.getElementsByClassName('bubble');
            for (let b of bubbles) {
                const rect = b.getBoundingClientRect();
                // Verificar si el dedo (x,y) est√° dentro del cuadro de la letra
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    // ¬°Toque detectado!
                    lastTouchedTime = now;
                    triggerLetter(b);
                    break;
                }
            }
        }

        // === L√ìGICA DE C√ÅMARA ===
        async function initGame() {
            document.getElementById('loading-msg').innerText = "Iniciando c√°mara...";
            
            // Configurar tama√±o del canvas igual a la ventana
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;

            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 1280,
                height: 720
            });
            
            await camera.start();
            document.getElementById('start-screen').classList.add('hidden');
            nextLevel();
        }

        // === L√ìGICA DE JUEGO ===
        function nextLevel() {
            document.getElementById('win-screen').classList.add('hidden');
            bubblesContainer.innerHTML = '';
            slotsContainer.innerHTML = '';
            currentIdx = 0;
            
            targetWord = words[Math.floor(Math.random() * words.length)];
            
            // Crear slots
            for(let char of targetWord) {
                let div = document.createElement('div');
                div.className = 'target-box';
                div.innerText = "_";
                slotsContainer.appendChild(div);
            }

            // Crear letras
            let letters = targetWord.split('').sort(() => Math.random() - 0.5);
            letters.forEach(char => createBubble(char));

            speak("Forma la palabra " + targetWord);
        }

        function createBubble(char) {
            let b = document.createElement('div');
            b.className = 'bubble';
            b.innerText = char;
            
            // Posici√≥n aleatoria
            const maxX = window.innerWidth - 100;
            const maxY = window.innerHeight - 150;
            b.style.left = (Math.random() * maxX + 50) + 'px';
            b.style.top = (Math.random() * (maxY - 150) + 150) + 'px';
            
            // Click de Mouse
            b.onclick = () => triggerLetter(b);
            
            bubblesContainer.appendChild(b);
        }

        function triggerLetter(element) {
            const char = element.innerText;
            const correctChar = targetWord[currentIdx];

            if (char === correctChar) {
                // Correcto
                element.style.transform = "scale(1.5)";
                element.style.opacity = "0";
                setTimeout(() => element.remove(), 200);
                
                let slots = document.getElementsByClassName('target-box');
                slots[currentIdx].innerText = char;
                slots[currentIdx].classList.add('filled');
                
                speak(char);
                currentIdx++;

                if (currentIdx >= targetWord.length) {
                    setTimeout(() => {
                        document.getElementById('win-word').innerText = targetWord;
                        document.getElementById('win-screen').classList.remove('hidden');
                        speak("¬°Muy bien! " + targetWord);
                    }, 500);
                }
            } else {
                // Incorrecto
                element.style.backgroundColor = "red";
                setTimeout(() => element.style.backgroundColor = "", 300);
                speak("Esa no");
            }
        }

        function speak(txt) {
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'es-ES';
            synth.speak(u);
        }

        // Ajustar canvas si cambian tama√±o de ventana
        window.addEventListener('resize', () => {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        });

    </script>
</body>
</html>